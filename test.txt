import asyncio
import os
import shutil
import nest_asyncio
from urllib.parse import quote
from aiogram import F, Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from shazamio import Shazam
from audio_separator.separator import Separator

nest_asyncio.apply()

# --- –ö–û–ù–§–ò–ì ---
bot = Bot(token=TOKEN)
dp = Dispatcher()
shazam = Shazam()

# –•—Ä–∞–Ω–∏–ª–∏—â–µ —è–∑—ã–∫–æ–≤ –≤ –ø–∞–º—è—Ç–∏ (—Å–±—Ä–æ—Å–∏—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞)
user_languages = {}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ò–ò (–º–æ–¥–µ–ª—å Kim_Inst –±—ã—Å—Ç—Ä–µ–µ –∏ –ª—É—á—à–µ –¥–ª—è Shazam)
global_separator = Separator(output_format='WAV')
print("ü§ñ –ó–∞–≥—Ä—É–∑–∫–∞ –ò–ò –º–æ–¥–µ–ª–∏ Kim_Inst... –ü–æ–¥–æ–∂–¥–∏—Ç–µ...")
global_separator.load_model('Kim_Inst.onnx')

# --- –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø ---
MESSAGES = {
    'ru': {
        'start': "üëã –ü—Ä–∏–≤–µ—Ç –≤ **StemFinder**! \n\n–Ø –Ω–∞–π–¥—É –ø–µ—Å–Ω—é, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–º –≥—Ä–æ–º–∫–∏–π –≥–æ–ª–æ—Å. –ü—Ä–∏—à–ª–∏ –º–Ω–µ –∞—É–¥–∏–æ –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ (–¥–æ 20 —Å–µ–∫).",
        'select_lang': "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Select language:",
        'processing': "‚è≥ –†–∞–±–æ—Ç–∞—é –Ω–∞–¥ —Ñ–∞–π–ª–æ–º...",
        'ai_start': "‚ùå –ù–µ —É–∑–Ω–∞–ª... –í–∫–ª—é—á–∞—é –ò–ò-–æ—á–∏—Å—Ç–∫—É –≥–æ–ª–æ—Å–∞... üß†",
        'ai_final': "üß† –ì–æ–ª–æ—Å —É–¥–∞–ª–µ–Ω. –ò—â—É –ø–æ —á–∏—Å—Ç–æ–º—É –º–∏–Ω—É—Å—É...",
        'not_found': "üòî –î–∞–∂–µ –ò–ò –Ω–µ —Å–º–æ–≥ —É–∑–Ω–∞—Ç—å —ç—Ç–æ—Ç —Ç—Ä–µ–∫.",
        'error': "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.",
        'btn_spotify': "üü¢ –°–ø–æ—Ç–∏—Ñ–∞–π",
        'btn_apple': "üçé –≠–ø–ª –ú—É–∑—ã–∫–∞"
    },
    'en': {
        'start': "üëã Welcome to **StemFinder**! \n\nI can find songs even with loud vocals. Send me audio or voice (up to 20s).",
        'select_lang': "Select your language / –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
        'processing': "‚è≥ Processing your file...",
        'ai_start': "‚ùå Not recognized. Starting AI vocal removal... üß†",
        'ai_final': "üß† Vocals removed. Searching by instrumental...",
        'not_found': "üòî Even AI couldn't recognize this track.",
        'error': "‚ö†Ô∏è An error occurred. Please try again.",
        'btn_spotify': "üü¢ Spotify",
        'btn_apple': "üçé Apple Music"
    }
}

# --- –£–¢–ò–õ–ò–¢–´ ---
def prepare_user_dir(user_id):
    user_dir = f"downloads/{user_id}"
    os.makedirs(user_dir, exist_ok=True)
    return user_dir

# --- –•–ï–ù–î–õ–ï–†–´ ---

@dp.message(Command("start"))
async def cmd_start(message: Message):
    user_id = message.from_user.id

    # –ï—Å–ª–∏ —è–∑—ã–∫ –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±—Ä–∞—Ç—å
    if user_id not in user_languages:
        buttons = [
            [InlineKeyboardButton(text="–†—É—Å—Å–∫–∏–π üá∑üá∫", callback_data="setlang_ru")],
            [InlineKeyboardButton(text="English üá∫üá∏", callback_data="setlang_en")]
        ]
        keyboard = InlineKeyboardMarkup(inline_keyboard=buttons)
        await message.answer(MESSAGES['en']['select_lang'], reply_markup=keyboard)
    else:
        lang = user_languages[user_id]
        await message.answer(MESSAGES[lang]['start'], parse_mode="Markdown")

@dp.callback_query(F.data.startswith("setlang_"))
async def set_lang(call: CallbackQuery):
    lang = call.data.split("_")[1]
    user_languages[call.from_user.id] = lang
    await call.message.edit_text(MESSAGES[lang]['start'], parse_mode="Markdown")

@dp.message(F.audio | F.voice)
async def handle_audio(message: Message):
    user_id = message.from_user.id
    lang = user_languages.get(user_id, 'en') # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
    user_dir = prepare_user_dir(user_id)

    audio_obj = message.audio if message.audio else message.voice

    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    if audio_obj.duration > 25:
        return await message.reply("Too long! Max 25s / –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ! –ú–∞–∫—Å 25 —Å–µ–∫.")

    status_msg = await message.answer(MESSAGES[lang]['processing'])

    file_id = audio_obj.file_id
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º os.path.join, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫ —Å –ø—É—Ç—è–º–∏
    input_path = os.path.join(user_dir, f"{file_id}_in.raw")
    output_wav = os.path.join(user_dir, f"{file_id}_out.wav")

    try:
        # 1. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
        file = await bot.get_file(file_id)
        await bot.download_file(file.file_path, input_path)

        # 2. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –º–æ–Ω–æ/44100–ì—Ü (–∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è Shazam)
        process = await asyncio.create_subprocess_exec(
            'ffmpeg', '-hide_banner', '-loglevel', 'error',
            '-i', input_path,
            '-ar', '44100', '-ac', '1',
            '-af', 'loudnorm',
            output_wav, '-y'
        )
        await process.wait()

        # 3. –ü–æ–∏—Å–∫ 1: –ü–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—É
        out = await shazam.recognize_song(output_wav)

        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –ò–ò
        if not out.get('track'):
            await status_msg.edit_text(MESSAGES[lang]['ai_start'])

            # –î–∏–∫—Ç—É–µ–º —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä—É –ø–∞–ø–∫—É —é–∑–µ—Ä–∞
            global_separator.output_dir = user_dir
            loop = asyncio.get_event_loop()

            # –†–∞–∑–¥–µ–ª—è–µ–º (–∑–∞–ø—É—Å–∫–∞–µ–º –≤ executor, —á—Ç–æ–±—ã –Ω–µ —Ñ—Ä–∏–∑–∏—Ç—å –±–æ—Ç–∞)
            output_files = await loop.run_in_executor(None, global_separator.separate, output_wav)

            instr_file = None
            for f in output_files:
                # –û—á–∏—â–∞–µ–º –∏–º—è –æ—Ç –ª–∏—à–Ω–∏—Ö –∫–∞–≤—ã—á–µ–∫
                clean_f = f.strip("'\"")
                if 'Instrumental' in clean_f:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ —Ñ–∞–π–ª: –≤ –∫–æ—Ä–Ω–µ –∏–ª–∏ –≤ –ø–∞–ø–∫–µ —é–∑–µ—Ä–∞
                    if os.path.exists(clean_f):
                        instr_file = os.path.join(user_dir, clean_f)
                        shutil.move(clean_f, instr_file)
                    elif os.path.exists(os.path.join(user_dir, clean_f)):
                        instr_file = os.path.join(user_dir, clean_f)
                    break

            if instr_file:
                await status_msg.edit_text(MESSAGES[lang]['ai_final'])

                # –£—Å–∏–ª–∏–≤–∞–µ–º "–º–∏–Ω—É—Å" –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
                boosted = os.path.join(user_dir, "boosted_instr.wav")
                process = await asyncio.create_subprocess_exec(
                    'ffmpeg', '-hide_banner', '-loglevel', 'error',
                    '-i', instr_file,
                    '-af', 'highpass=f=200,lowpass=f=4000,loudnorm',
                    boosted, '-y'
                )
                await process.wait()

                # –ü–æ–∏—Å–∫ 2: –ü–æ –æ—á–∏—â–µ–Ω–Ω–æ–º—É –º–∏–Ω—É—Å—É
                out = await shazam.recognize_song(boosted)

        # 4. –†–ï–ó–£–õ–¨–¢–ê–¢
        if out.get('track'):
            title = out['track']['title']
            artist = out['track']['subtitle']

            # –ö–æ–¥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å—Å—ã–ª–æ–∫
            safe_q = quote(f"{artist} {title}")

            buttons = [
                [InlineKeyboardButton(text=MESSAGES[lang]['btn_spotify'], url=f"https://www.google.com/search?q=spotify+music+{safe_q}")],
                [InlineKeyboardButton(text=MESSAGES[lang]['btn_apple'], url=out['track'].get('url', f"https://music.apple.com/search?term={safe_q}"))]
            ]

            await status_msg.edit_text(
                f"‚úÖ **{title}**\nüë§ {artist}",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons),
                parse_mode="Markdown"
            )
        else:
            await status_msg.edit_text(MESSAGES[lang]['not_found'])

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        await status_msg.edit_text(MESSAGES[lang]['error'])

    finally:
        # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if os.path.exists(user_dir):
            shutil.rmtree(user_dir, ignore_errors=True)

async def main():
    # –£–¥–∞–ª—è–µ–º –≤–µ–±—Ö—É–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ª–∏–Ω–≥
    await bot.delete_webhook(drop_pending_updates=True)
    print("üöÄ StemFinder –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    await dp.start_polling(bot)

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except (KeyboardInterrupt, SystemExit):
        print("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
